name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build and release binaries
  release-binaries:
    name: Release ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-latest
            name: koru-delta-macos-intel
          - target: aarch64-apple-darwin
            os: macos-latest
            name: koru-delta-macos-arm
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: koru-delta-linux-x64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: koru-delta-windows-x64.exe

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package binary (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/kdelta dist/${{ matrix.name }}
          cp target/${{ matrix.target }}/release/libkoru_delta.rlib dist/ 2>/dev/null || true
          cd dist && tar czf ${{ matrix.name }}.tar.gz ${{ matrix.name }}

      - name: Package binary (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          mkdir dist
          cp target/${{ matrix.target }}/release/kdelta.exe dist/${{ matrix.name }}
          cd dist && 7z a ${{ matrix.name }}.zip ${{ matrix.name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: dist/${{ matrix.name }}.*

  # Build and publish npm package
  release-npm:
    name: Release npm package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM package
        run: wasm-pack build --no-default-features --features wasm --target web

      - name: Update package.json
        working-directory: pkg
        run: |
          jq '.files += ["JS_API.md", "WASM_QUICKSTART.md"]' package.json > tmp.json && mv tmp.json package.json

      - name: Publish to npm
        working-directory: pkg
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "//registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN" > .npmrc
          npm publish --access public || true

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [release-binaries, release-npm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## KoruDelta v2.0.0

          ### Overview
          Production-ready causal database with complete feature set: materialized views, self-sovereign auth, vector search, real-time subscriptions, and WASM support.

          ### What's New

          #### Materialized Views
          - Persistent view definitions with auto-refresh
          - Views survive database restarts
          - Query caching for instant results
          - CLI: `kdelta view create/list/query/refresh/delete`

          #### Self-Sovereign Authentication
          - Proof-of-work identity mining
          - Ed25519 cryptographic signatures
          - Challenge-response authentication
          - Capability-based authorization

          #### Vector Search
          - Vector embedding storage with metadata
          - Cosine similarity and Euclidean distance
          - SNSW (Synthesis-Navigable Small World) ANN search
          - Time-travel vector search
          - WASM support for browser-based AI

          #### Real-time Subscriptions
          - Pub/sub change notifications
          - Filterable by collection, key, change type
          - Broadcast-based delivery

          #### WASM/Browser Support
          - Full JavaScript API via wasm-bindgen
          - IndexedDB persistence for data survival
          - Auto-save and auto-load

          #### Batch Write Operations
          - `put_batch()` API for bulk writes (10-50x faster)
          - Single fsync for entire batch

          ### Performance
          - **Writes (single):** ~201 ops/sec
          - **Writes (batch):** ~3,500 ops/sec (16x improvement)
          - **Reads:** ~134K ops/sec
          - **Binary size:** ~11MB

          ### Installation

          #### Binary
          Download the appropriate binary for your platform above.

          #### Cargo
          ```bash
cargo install koru-delta
```

          #### npm
          ```bash
npm install koru-delta
```

          ### Quick Start
          ```bash
# Start the CLI
kdelta set users/alice '{"name": "Alice"}'
kdelta get users/alice
kdelta log users/alice
```

          See [README.md](README.md) for full documentation.
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
